<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IVPLAST | Configura√ß√µes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f3f5f7;}
    .app{display:flex;min-height:100vh;}
    .sidebar{width:260px;background:#fff;border-right:1px solid #e9ecef;padding:18px 14px;position:sticky;top:0;height:100vh;}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#344054;text-decoration:none;}
    .nav a:hover{background:#f2f4f7;}
    .nav a.active{background:#e8f2ff;color:#0b5ed7;font-weight:600;}
    .content{flex:1;padding:22px;}
    .panel{border:0;border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,.06);}
    .topbar{background:#fff;border:1px solid #e9ecef;border-radius:14px;padding:12px 14px;box-shadow:0 4px 18px rgba(0,0,0,.04);margin-bottom:18px;}
    .btn-primary{background:#1177cc;border-color:#1177cc;}
    .table thead th{font-size:12px;text-transform:uppercase;letter-spacing:.02em;color:#667085;}
    .badge-role{background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff;}
    .muted{color:#667085;}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #e5e7eb;background:#fff;}
    .pill.ok{background:#ecfdf3;border-color:#bbf7d0;color:#166534;}
    .pill.off{background:#fff1f2;border-color:#fecdd3;color:#9f1239;}
    .helpbox{background:#fff;border:1px dashed #d0d5dd;border-radius:12px;padding:10px 12px;}
  </style>
</head>
<body>
<%
  const cfg = (typeof config !== 'undefined' && config) ? config : {
    adminEmail: "", adminName: "", databaseSSL: true
  };
  const usersList = (typeof users !== 'undefined' && users) ? users : [];
%>

<div class="app">
  <aside class="sidebar">
    <div class="d-flex align-items-center gap-2 px-2 mb-3">
      <img src="https://dummyimage.com/120x34/ffffff/1177cc.png&text=IVPLAST" style="height:34px;" alt="IVPLAST">
      <div>
        <div class="fw-semibold">IVPLAST</div>
        <div class="small text-secondary">Ocorr√™ncias</div>
      </div>
    </div>
    <div class="nav flex-column">
      <a href="/dashboard">üè† Menu Principal</a>
      <a href="/novo">‚ûï Novo</a>
      <a href="/ocorrencias">üîé Busca por Ocorr√™ncia</a>
      <a href="/relatorios">üìä Relat√≥rios</a>
      <a class="active" href="/configuracoes">‚öôÔ∏è Configura√ß√µes</a>
      <a href="/auditoria">üßæ Auditoria</a>
      <hr class="my-2"/>
      <a href="/logout">üö™ Sair</a>
    </div>
  </aside>

  <main class="content">
    <div class="topbar d-flex align-items-start justify-content-between gap-3">
      <div>
        <div class="fw-semibold">Configura√ß√µes</div>
        <div class="small text-secondary">Par√¢metros do sistema e gest√£o de usu√°rios.</div>
      </div>
      <div class="small text-secondary">
        Logado como: <b><%= (usuario && usuario.nome) ? usuario.nome : '-' %></b>
      </div>
    </div>

    <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success"><%= success %></div>
    <% } %>
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>

    <!-- Abas -->
    <ul class="nav nav-tabs mb-3" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-sistema" data-bs-toggle="tab" data-bs-target="#pane-sistema" type="button" role="tab">
          ‚öôÔ∏è Sistema
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-usuarios" data-bs-toggle="tab" data-bs-target="#pane-usuarios" type="button" role="tab">
          üë§ Usu√°rios e Permiss√µes
        </button>
      </li>
    </ul>

    <div class="tab-content">

      <!-- SISTEMA -->
      <div class="tab-pane fade show active" id="pane-sistema" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="card panel">
              <div class="card-body">
                <div class="fw-semibold mb-2">Admin</div>
                <form method="POST" action="/configuracoes/admin">
                  <div class="mb-2">
                    <label class="form-label small">Admin email</label>
                    <input name="adminEmail" class="form-control" value="<%= cfg.adminEmail %>" placeholder="admin@empresa.com">
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Admin nome</label>
                    <input name="adminName" class="form-control" value="<%= cfg.adminName %>" placeholder="Nome do admin">
                  </div>
                  <button class="btn btn-primary btn-sm mt-2" type="submit">Salvar</button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card panel">
              <div class="card-body">
                <div class="fw-semibold mb-2">Seguran√ßa (minha senha)</div>
                <form method="POST" action="/configuracoes/senha">
                  <div class="mb-2">
                    <label class="form-label small">Nova senha</label>
                    <input name="novaSenha" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Confirmar</label>
                    <input name="novaSenha2" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                  </div>
                  <button class="btn btn-outline-primary btn-sm mt-2" type="submit">Alterar senha</button>
                </form>
                <hr>
                <div class="small text-secondary">
                  <div><b>Obs.:</b> senhas n√£o s√£o exibidas (ficam criptografadas). Para equipe, use ‚ÄúResetar senha‚Äù.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-12">
            <div class="card panel">
              <div class="card-body">
                <div class="fw-semibold mb-2">Status do ambiente</div>
                <div class="row g-2 small">
                  <div class="col-md-4"><span class="text-secondary">DATABASE_SSL:</span> <b><%= cfg.databaseSSL ? 'true' : 'false' %></b></div>
                  <div class="col-md-4"><span class="text-secondary">Node env:</span> <b><%= (typeof process !== 'undefined' && process.env && process.env.NODE_ENV) ? process.env.NODE_ENV : 'dev' %></b></div>
                  <div class="col-md-4"><span class="text-secondary">App:</span> <b>ivplast-reclamacoes</b></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- USU√ÅRIOS -->
      <div class="tab-pane fade" id="pane-usuarios" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-5">
            <div class="card panel">
              <div class="card-body">
                <div class="fw-semibold mb-2">Criar usu√°rio</div>

                <form method="POST" action="/configuracoes/usuarios/criar">
                  <div class="mb-2">
                    <label class="form-label small">Nome</label>
                    <input name="nome" class="form-control" placeholder="Ex.: Jo√£o Silva" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Email</label>
                    <input name="email" class="form-control" placeholder="joao@empresa.com" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Senha inicial</label>
                    <input name="senha" type="password" class="form-control" placeholder="m√≠nimo 6 caracteres" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Cargo (Role)</label>
                    <select name="role" class="form-select">
                      <option value="user">Usu√°rio</option>
                      <option value="comercial">Comercial</option>
                      <option value="atendimento">Atendimento</option>
                      <option value="logistica">Log√≠stica</option>
                      <option value="financeiro">Financeiro</option>
                      <option value="qualidade">Qualidade</option>
                      <option value="admin">Admin</option>
                      <option value="diretor">Diretor</option>
                    </select>
                    <div class="form-text muted">Diretor = acesso total (Configura√ß√µes, Auditoria e ‚ÄúResolvido‚Äù).</div>
                  </div>

                  <button class="btn btn-primary btn-sm mt-2" type="submit">Criar usu√°rio</button>
                </form>

                <div class="mt-3 helpbox small">
                  <div class="fw-semibold mb-1">Regras atuais do sistema</div>
                  <div>‚Ä¢ Todos logados podem baixar anexos</div>
                  <div>‚Ä¢ S√≥ Diretor pode marcar ‚ÄúResolvido‚Äù</div>
                  <div>‚Ä¢ S√≥ Diretor acessa Configura√ß√µes e Auditoria</div>
                  <div class="mt-2 muted">Se quiser, depois colocamos permiss√µes finas por fun√ß√£o (ex.: ‚Äúpode ver custo‚Äù, ‚Äúpode excluir‚Äù, etc.).</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card panel">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                  <div class="fw-semibold">Usu√°rios cadastrados</div>
                  <div class="small muted">Total: <b><%= usersList.length %></b></div>
                </div>

                <% if (!usersList || usersList.length === 0) { %>
                  <div class="muted">Nenhum usu√°rio encontrado.</div>
                <% } else { %>
                  <div class="table-responsive">
                    <table class="table align-middle">
                      <thead>
                        <tr>
                          <th>Nome</th>
                          <th>Email</th>
                          <th>Cargo</th>
                          <th>Status</th>
                          <th class="text-end">A√ß√µes</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% usersList.forEach((u) => { %>
                          <tr>
                            <td class="fw-semibold"><%= u.nome || '-' %></td>
                            <td class="muted"><%= u.email || '-' %></td>
                            <td>
                              <span class="badge badge-role"><%= u.role || 'user' %></span>
                            </td>
                            <td>
                              <% if (u.active === false) { %>
                                <span class="pill off">Desativado</span>
                              <% } else { %>
                                <span class="pill ok">Ativo</span>
                              <% } %>
                            </td>
                            <td class="text-end">
                              <!-- Trocar role -->
                              <form method="POST" action="/configuracoes/usuarios/<%= u.id %>/role" class="d-inline">
                                <select name="role" class="form-select form-select-sm d-inline" style="width:auto;display:inline-block">
                                  <option value="user" <%= (u.role==='user')?'selected':'' %>>Usu√°rio</option>
                                  <option value="comercial" <%= (u.role==='comercial')?'selected':'' %>>Comercial</option>
                                  <option value="atendimento" <%= (u.role==='atendimento')?'selected':'' %>>Atendimento</option>
                                  <option value="logistica" <%= (u.role==='logistica')?'selected':'' %>>Log√≠stica</option>
                                  <option value="financeiro" <%= (u.role==='financeiro')?'selected':'' %>>Financeiro</option>
                                  <option value="qualidade" <%= (u.role==='qualidade')?'selected':'' %>>Qualidade</option>
                                  <option value="admin" <%= (u.role==='admin')?'selected':'' %>>Admin</option>
                                  <option value="diretor" <%= (u.role==='diretor' || u.role==='diretoria')?'selected':'' %>>Diretor</option>
                                </select>
                                <button class="btn btn-outline-primary btn-sm ms-1" type="submit">Salvar</button>
                              </form>

                              <!-- Ativar/Desativar -->
                              <form method="POST" action="/configuracoes/usuarios/<%= u.id %>/active" class="d-inline ms-1">
                                <input type="hidden" name="active" value="<%= (u.active === false) ? 'true' : 'false' %>">
                                <% if (u.active === false) { %>
                                  <button class="btn btn-outline-success btn-sm" type="submit">Ativar</button>
                                <% } else { %>
                                  <button class="btn btn-outline-danger btn-sm" type="submit">Desativar</button>
                                <% } %>
                              </form>

                              <!-- Reset senha -->
                              <button class="btn btn-outline-secondary btn-sm ms-1" type="button"
                                data-bs-toggle="modal" data-bs-target="#modalResetSenha"
                                data-userid="<%= u.id %>" data-username="<%= (u.nome||'') %>">
                                Reset senha
                              </button>
                            </td>
                          </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>

                  <div class="small muted">
                    * ‚ÄúReset senha‚Äù define uma nova senha. N√£o √© poss√≠vel ‚Äúver‚Äù a senha atual.
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- Modal Reset Senha -->
<div class="modal fade" id="modalResetSenha" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="POST" action="/configuracoes/usuarios/0/reset-senha" id="resetForm">
      <div class="modal-header">
        <h5 class="modal-title">Resetar senha</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="small text-secondary mb-2">
          Usu√°rio: <b id="resetUserName">-</b>
        </div>
        <div class="mb-2">
          <label class="form-label small">Nova senha</label>
          <input name="novaSenha" type="password" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label small">Confirmar</label>
          <input name="novaSenha2" type="password" class="form-control" required>
        </div>
        <div class="form-text muted">
          A senha anterior deixa de valer imediatamente.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Salvar nova senha</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const modal = document.getElementById('modalResetSenha');
  const form  = document.getElementById('resetForm');
  const nameEl = document.getElementById('resetUserName');

  modal.addEventListener('show.bs.modal', function (event) {
    const btn = event.relatedTarget;
    const userId = btn.getAttribute('data-userid');
    const userName = btn.getAttribute('data-username') || '-';

    nameEl.textContent = userName;
    form.setAttribute('action', `/configuracoes/usuarios/${userId}/reset-senha`);
  });
</script>
</body>
</html>
