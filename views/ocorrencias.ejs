<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IVPLAST | OcorrÃªncias</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f3f5f7;}
    .app{display:flex;min-height:100vh;}
    .sidebar{width:260px;background:#fff;border-right:1px solid #e9ecef;padding:18px 14px;position:sticky;top:0;height:100vh;}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#344054;text-decoration:none;}
    .nav a:hover{background:#f2f4f7;}
    .nav a.active{background:#e8f2ff;color:#0b5ed7;font-weight:600;}
    .content{flex:1;padding:22px;}
    .panel{border:0;border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,.06);}
    .topbar{background:#fff;border:1px solid #e9ecef;border-radius:14px;padding:12px 14px;box-shadow:0 4px 18px rgba(0,0,0,.04);margin-bottom:18px;}
  </style>
</head>
<body>
<%
  const user = (typeof usuario !== 'undefined' && usuario) ? usuario : { nome: "UsuÃ¡rio", role: "" };
  const lista = (typeof ocorrencias !== 'undefined' && ocorrencias) ? ocorrencias : [];
  const currentQ = (typeof q !== 'undefined' ? q : '');
  const currentStatus = (typeof status !== 'undefined' ? status : '');

  const STATUS = [
    "Aberto",
    "Em anÃ¡lise",
    "Aguardando cliente",
    "Aguardando fÃ¡brica",
    "Finalizado â€“ Financeiro",
    "Diretoria"
  ];

  function badgeClass(st){
    if (st === "Aberto") return "text-bg-danger";
    if (st === "Em anÃ¡lise") return "text-bg-warning";
    if (st === "Aguardando cliente") return "text-bg-info";
    if (st === "Aguardando fÃ¡brica") return "text-bg-info";
    if (st === "Finalizado â€“ Financeiro") return "text-bg-primary";
    if (st === "Diretoria") return "text-bg-success";
    return "text-bg-secondary";
  }

  const role = (user && user.role) ? String(user.role).toLowerCase() : '';
  const canCreate = role !== 'financeiro';
  const canSeeAdminMenus = (role === 'admin' || role === 'diretor');
%>

<div class="app">
  <aside class="sidebar">
    <div class="d-flex align-items-center gap-2 px-2 mb-3">
      <img src="https://dummyimage.com/120x34/ffffff/1177cc.png&text=IVPLAST" style="height:34px;" alt="IVPLAST">
      <div>
        <div class="fw-semibold">IVPLAST</div>
        <div class="small text-secondary">OcorrÃªncias</div>
      </div>
    </div>
    <div class="nav flex-column">
      <a href="/dashboard">ğŸ  Menu Principal</a>
      <% if (canCreate) { %>
        <a href="/novo">â• Novo</a>
      <% } %>
      <a class="active" href="/ocorrencias">ğŸ” Busca por OcorrÃªncia</a>
      <a href="/relatorios">ğŸ“Š RelatÃ³rios</a>

      <% if (canSeeAdminMenus) { %>
        <a href="/configuracoes">âš™ï¸ ConfiguraÃ§Ãµes</a>
        <a href="/auditoria">ğŸ§¾ Auditoria</a>
      <% } %>

      <hr class="my-2"/>
      <a href="/logout">ğŸšª Sair</a>
    </div>
  </aside>

  <main class="content">
    <div class="topbar d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <div class="small text-secondary">Menu Principal / OcorrÃªncias</div>
        <div class="fw-semibold">Bem-vindo ao sistema, <%= user.nome %>!</div>
      </div>

      <div class="d-flex gap-2 flex-wrap">
        <form class="d-flex" method="GET" action="/ocorrencias">
          <input class="form-control" name="q" placeholder="Pesquisar solicitaÃ§Ãµes" value="<%= currentQ %>">
          <% if (currentStatus) { %>
            <input type="hidden" name="status" value="<%= currentStatus %>">
          <% } %>
          <button class="btn btn-outline-secondary ms-2" type="submit">Buscar</button>
        </form>

        <% if (canCreate) { %>
          <a class="btn btn-primary" href="/novo">+ Nova ocorrÃªncia</a>
        <% } %>
      </div>
    </div>

    <div class="card panel">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <div class="fw-semibold">OcorrÃªncias</div>
          <div class="d-flex gap-2">
            <select class="form-select form-select-sm" style="min-width:220px"
              onchange="
                const url = new URL(window.location.href);
                if(this.value){ url.searchParams.set('status', this.value); } else { url.searchParams.delete('status'); }
                window.location.href = url.toString();
              ">
              <option value="">Todos os status</option>
              <% STATUS.forEach(s => { %>
                <option value="<%= s %>" <%= String(currentStatus)===String(s) ? 'selected' : '' %>><%= s %></option>
              <% }) %>
            </select>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="table-light">
              <tr>
                <th>Cliente</th>
                <th>ID</th>
                <th>Criado</th>
                <th>Ãšltima atividade</th>
                <th class="text-end">Status</th>
              </tr>
            </thead>
            <tbody>
              <% if (!lista.length) { %>
                <tr>
                  <td colspan="5" class="text-center text-secondary py-4">Nenhuma ocorrÃªncia encontrada.</td>
                </tr>
              <% } %>

              <% lista.forEach(o => { %>
                <tr>
                  <td>
                    <a class="text-decoration-none" href="/ocorrencias/<%= o.id %>"><%= o.cliente %></a>
                  </td>
                  <td>#<%= o.id %></td>
                  <td><%= o.criadoEm %></td>
                  <td><%= o.ultimaAtividade %></td>
                  <td class="text-end">
                    <span class="badge <%= badgeClass(o.status) %>"><%= o.status %></span>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </main>
</div>
</body>
</html>
