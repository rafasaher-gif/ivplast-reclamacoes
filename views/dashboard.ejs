<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOLUÇÕES DE BUCHAS IVPLAST</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --muted:#94a3b8;
      --text:#e2e8f0;
      --line:#1f2a44;
      --chip:#111c33;
      --brand:#60a5fa;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --white:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(34,197,94,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1120px; margin:0 auto; padding:24px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; padding:18px 18px;
      background: rgba(15, 23, 42, .78);
      border:1px solid rgba(148,163,184,.15);
      border-radius:16px;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
    }
    .brand h1{
      margin:0; font-size:20px; letter-spacing:.2px;
    }
    .brand small{color:var(--muted)}
    .nav{
      display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-end;
    }
    .nav a{
      padding:8px 10px; border-radius:10px;
      background: rgba(17,28,51,.6);
      border:1px solid rgba(148,163,184,.14);
      color:var(--text);
      font-size:13px;
    }
    .nav a:hover{background: rgba(17,28,51,.9)}
    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: rgba(15, 23, 42, .75);
      border:1px solid rgba(148,163,184,.14);
      border-radius:16px;
      padding:16px;
      backdrop-filter: blur(10px);
    }
    .card h2{margin:0 0 10px 0; font-size:16px}
    .filters{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin:10px 0 12px 0;
    }
    .search{
      flex:1;
      min-width:240px;
      display:flex; gap:8px; align-items:center;
      background: rgba(17,28,51,.6);
      border:1px solid rgba(148,163,184,.14);
      border-radius:12px;
      padding:10px 10px;
    }
    .search input{
      width:100%;
      border:0; outline:0; background:transparent;
      color:var(--text); font-size:14px;
    }
    .search button{
      border:0; cursor:pointer;
      padding:8px 10px;
      border-radius:10px;
      background: rgba(96,165,250,.18);
      color:var(--text);
      font-weight:600;
    }
    .search button:hover{background: rgba(96,165,250,.28)}
    .select{
      display:flex; gap:8px; align-items:center;
      min-width:190px; justify-content:flex-end;
      color:var(--muted);
      font-size:13px;
    }
    .select select{
      width:160px;
      border-radius:10px;
      padding:10px 10px;
      background: rgba(17,28,51,.6);
      border:1px solid rgba(148,163,184,.14);
      color:var(--text);
      outline:0;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.35);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:12px 12px;
      background: rgba(17,28,51,.55);
      border-bottom:1px solid rgba(148,163,184,.10);
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(148,163,184,.08);
      font-size:13px;
      vertical-align:middle;
    }
    tbody tr:hover{background: rgba(96,165,250,.06)}
    tbody tr:last-child td{border-bottom:0}
    .id{color:var(--muted); font-variant-numeric: tabular-nums}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(17,28,51,.6);
      white-space:nowrap;
    }
    .b-open{color:#fecaca; background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.25)}
    .b-progress{color:#fde68a; background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25)}
    .b-done{color:#bbf7d0; background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.25)}
    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    .kpi{
      padding:12px;
      border-radius:14px;
      background: rgba(17,28,51,.55);
      border:1px solid rgba(148,163,184,.12);
    }
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .value{font-size:20px; margin-top:6px; font-weight:800}
    .foot{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }
  </style>
</head>
<body>
<%
  // Se o server mandar dados, ele usa. Se não mandar, mostra exemplos (visual).
  const userEmail = (typeof user !== "undefined" && user && user.email) ? user.email : "raphael@ivplast.com.br";
  const userRole  = (typeof user !== "undefined" && user && user.role)  ? user.role  : "VENDEDOR";

  const sample = [
    { cliente:"SOLDAS BRASIL COMERCIAL LTDA", id:"#12484", criado:"há 27 dias", ultima:"há 2 horas", status:"Aberto" },
    { cliente:"3E COMERCIAL LTDA",           id:"#12619", criado:"há 24 dias", ultima:"há 2 horas", status:"Aberto" }
  ];

  const list = (typeof ocorrencias !== "undefined" && Array.isArray(ocorrencias) && ocorrencias.length)
    ? ocorrencias
    : sample;

  const abertas = list.filter(x => (x.status || "").toLowerCase() === "aberto").length;
  const total = list.length;
  const emAndamento = list.filter(x => (x.status || "").toLowerCase().includes("and")).length; // opcional
  const encerradas = list.filter(x => (x.status || "").toLowerCase().includes("enc")).length; // opcional

  function badgeClass(s){
    const t = (s||"").toLowerCase();
    if(t === "aberto") return "badge b-open";
    if(t.includes("and")) return "badge b-progress";
    if(t.includes("enc") || t.includes("final")) return "badge b-done";
    return "badge";
  }
%>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>SOLUÇÕES DE BUCHAS IVPLAST</h1>
        <small>Logado como: <b><%= userEmail %></b> (<%= userRole %>)</small>
      </div>

      <div class="nav">
        <a href="/dashboard">Menu principal</a>
        <a href="/novo">Novo</a>
        <a href="/ocorrencias">Busca por ocorrência</a>
        <a href="/relatorios">Relatório</a>
        <a href="/configuracoes">Configurações</a>
        <a href="/auditoria">Auditoria</a>
        <a href="/logout">Sair</a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Ocorrências em aberto</h2>

        <div class="filters">
          <form class="search" method="GET" action="/dashboard">
            <input name="q" placeholder="Pesquisar solicitações (cliente, ID, NF, pedido...)" />
            <button type="submit">Buscar</button>
          </form>

          <div class="select">
            <span>Status:</span>
            <select name="status" onchange="location.href='/dashboard?status='+encodeURIComponent(this.value)">
              <option value="">Qualquer um</option>
              <option value="Aberto">Aberto</option>
              <option value="Em andamento">Em andamento</option>
              <option value="Encerrado">Encerrado</option>
            </select>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:44%">Cliente</th>
              <th style="width:12%">ID</th>
              <th style="width:14%">Criado</th>
              <th style="width:18%">Última atividade</th>
              <th style="width:12%">Status</th>
            </tr>
          </thead>
          <tbody>
          <% list.forEach((o) => { %>
            <tr>
              <td>
                <a href="/ocorrencia/<%= (o.id || "").replace("#","") %>"><%= o.cliente || "-" %></a>
              </td>
              <td class="id"><%= o.id || "-" %></td>
              <td><%= o.criado || "-" %></td>
              <td><%= o.ultima || "-" %></td>
              <td><span class="<%= badgeClass(o.status) %>"><%= o.status || "-" %></span></td>
            </tr>
          <% }) %>
          </tbody>
        </table>

        <div class="foot">* Por enquanto os dados são exemplos (visual). Depois vamos ligar no banco.</div>
      </div>

      <div class="card">
        <h2>Resumo</h2>
        <div class="kpis">
          <div class="kpi">
            <div class="label">Em aberto</div>
            <div class="value"><%= abertas %></div>
          </div>
          <div class="kpi">
            <div class="label">Total na lista</div>
            <div class="value"><%= total %></div>
          </div>
          <div class="kpi">
            <div class="label">Em andamento (placeholder)</div>
            <div class="value"><%= emAndamento %></div>
          </div>
          <div class="kpi">
            <div class="label">Encerradas (placeholder)</div>
            <div class="value"><%= encerradas %></div>
          </div>
        </div>

        <div class="foot">
          Próximo passo: ligar isso no banco e filtrar “apenas Abertos”.
        </div>
      </div>
    </div>
  </div>

</body>
</html>

