<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="utf-8">
  <title>Ocorr√™ncia #<%= ocorrencia.id %> - IVPLAST</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f4f6fb;color:#0f172a}
    .layout{display:flex;min-height:100vh}
    .sidebar{width:250px;background:#fff;border-right:1px solid #e5e7eb;padding:18px}
    .logo{font-weight:800;color:#2563eb;margin-bottom:20px}
    .menu a{display:block;padding:10px 12px;border-radius:8px;color:#111;text-decoration:none;margin-bottom:6px}
    .menu a:hover{background:#f1f5f9}
    .menu a.active{background:#eef2ff;color:#1d4ed8;font-weight:600}
    .content{flex:1;padding:24px}
    .top{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:16px;display:flex;gap:12px;align-items:flex-start;justify-content:space-between}
    h1{margin:0;font-size:20px}
    .sub{margin:4px 0 0;color:#64748b;font-size:13px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid #e5e7eb;background:#fff}
    .pill.open{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .pill.done{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:18px;margin-bottom:14px}
    .section{font-weight:800;font-size:14px;margin:0 0 10px}
    label{display:block;font-size:13px;margin:10px 0 6px;color:#334155}
    input,select,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px}
    textarea{min-height:110px;resize:vertical}
    .btn{padding:10px 14px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer;font-weight:700}
    .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .hint{font-size:12px;color:#64748b;margin-top:8px}
    .line{height:1px;background:#e5e7eb;margin:12px 0}
    .activity{border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin-top:10px;background:#fff}
    .activity .meta{font-size:12px;color:#64748b;margin-bottom:6px}
    .activity .txt{font-size:14px;color:#0f172a;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere}
    .muted{color:#64748b}
    .rightInfo{font-size:13px;color:#64748b}
    a.link{color:#2563eb;text-decoration:none}
    a.link:hover{text-decoration:underline}
    .k{font-size:12px;color:#64748b}
    .v{font-size:14px;font-weight:700;color:#0f172a}
    .kv{display:flex;flex-direction:column;gap:2px}

    .itemCard{border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fff}

    .attachList{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .attachRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fff
    }
    .attachName{font-weight:700;font-size:14px;color:#0f172a;word-break:break-word;overflow-wrap:anywhere}
    .attachMeta{font-size:12px;color:#64748b;margin-top:2px}
    .attachLeft{display:flex;flex-direction:column;gap:2px;min-width:0;flex:1}
    .attachActions{display:flex;gap:8px;flex-shrink:0}
    .btn.small{padding:8px 10px;font-size:13px;border-radius:8px}

    @media(max-width:900px){
      .sidebar{display:none}
      .grid,.grid3{grid-template-columns:1fr}
      .content{padding:14px}
      .top{flex-direction:column}
      .attachRow{flex-direction:column;align-items:flex-start}
      .attachActions{width:100%}
      .attachActions .btn{width:100%}
    }
  </style>
</head>

<body>
<div class="layout">

  <aside class="sidebar">
    <div class="logo">IVPLAST</div>
    <div class="menu">
      <a href="/dashboard">üè† Menu Principal</a>
      <% if (String(role||'') !== 'financeiro') { %>
        <a href="/novo">‚ûï Novo</a>
      <% } %>
      <a href="/ocorrencias" class="active">üîç Busca por Ocorr√™ncia</a>
      <a href="/relatorios">üìä Relat√≥rios</a>

      <% if (String(role||'') === "admin" || String(role||'') === "diretor") { %>
        <a href="/configuracoes">‚öôÔ∏è Configura√ß√µes</a>
        <a href="/auditoria">üßæ Auditoria</a>
      <% } %>

      <a href="/logout">üö™ Sair</a>
    </div>
  </aside>

  <main class="content">

    <%
      const st = String(ocorrencia.status || "Aberto");
      const motivoLabel = (String(ocorrencia.motivo || "") === "IVPLAST") ? "F√°brica" : (ocorrencia.motivo || "-");
      const showCost = (typeof canSeeCost === "undefined") ? false : !!canSeeCost;

      const canEdit = (typeof canEditStatus === "undefined") ? false : !!canEditStatus;
      const allowed = (typeof allowedStatuses !== "undefined" && Array.isArray(allowedStatuses)) ? allowedStatuses : [st];

      const RESPONSAVEIS = ["Atendimento","Comercial","Financeiro","Diretoria"];
      const showResponsavelEdit = (typeof isAdmin !== "undefined" && !!isAdmin);

      function bytesToMB(n){
        const num = Number(n || 0);
        if (!num) return "-";
        return (num / (1024*1024)).toFixed(2).replace(".", ",") + " MB";
      }
      function dtNice(d){
        try{
          if(!d) return "";
          const dd = new Date(d);
          if(!Number.isFinite(dd.getTime())) return "";
          const yyyy = dd.getFullYear();
          const mm = String(dd.getMonth()+1).padStart(2,"0");
          const day = String(dd.getDate()).padStart(2,"0");
          const hh = String(dd.getHours()).padStart(2,"0");
          const mi = String(dd.getMinutes()).padStart(2,"0");
          return `${day}/${mm}/${yyyy} ${hh}:${mi}`;
        }catch{ return ""; }
      }
    %>

    <div class="top">
      <div>
        <div class="sub">
          <a class="link" href="/dashboard">Menu Principal</a>
          <span class="muted"> / </span>
          <a class="link" href="/ocorrencias">Ocorr√™ncias</a>
          <span class="muted"> / </span>
          <b>#<%= ocorrencia.id %></b>
        </div>
        <h1><%= ocorrencia.cliente %></h1>
        <div class="sub">Criado em: <b><%= ocorrencia.criadoEm %></b></div>
      </div>

      <div style="text-align:right">
        <div class="rightInfo">Logado como: <b><%= usuario.nome %></b></div>
        <div style="margin-top:8px">
          <span class="pill open"><%= ocorrencia.status %></span>
        </div>
      </div>
    </div>

    <div class="grid">

      <div class="card">
        <div class="section">Dados da ocorr√™ncia</div>

        <div class="grid3">
          <div class="kv">
            <div class="k">Faturado por</div>
            <div class="v"><%= ocorrencia.empresa || "-" %></div>
          </div>
          <div class="kv">
            <div class="k">Motivo / Origem</div>
            <div class="v"><%= motivoLabel %></div>
          </div>
          <div class="kv">
            <div class="k">Respons√°vel</div>
            <div class="v"><%= ocorrencia.responsavel || "-" %></div>
          </div>
        </div>

        <div class="line"></div>

        <div class="grid3">
          <div class="kv">
            <div class="k">Pedido</div>
            <div class="v"><%= ocorrencia.pedido || "-" %></div>
          </div>
          <div class="kv">
            <div class="k">Nota Fiscal</div>
            <div class="v"><%= ocorrencia.nf || "-" %></div>
          </div>
          <div class="kv">
            <div class="k">NFD</div>
            <div class="v"><%= ocorrencia.nfd || "-" %></div>
          </div>
        </div>

        <div class="line"></div>

        <div class="section" style="margin-top:0">Itens errados</div>

        <% if (!itens || itens.length === 0) { %>
          <div class="muted">Nenhum item informado.</div>
        <% } else { %>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <% itens.forEach((it, idx) => { %>
              <div class="itemCard">
                <div class="k">Item <%= idx + 1 %></div>
                <div class="v" style="font-size:14px;"><%= it.descricao %></div>

                <div style="margin-top:6px">
                  <div class="k">Quantidade</div>
                  <div class="v" style="font-size:14px;"><%= (it.quantidade !== null && it.quantidade !== undefined) ? it.quantidade : "-" %></div>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>

        <% if (showCost) { %>
          <div class="line"></div>
          <div class="kv">
            <div class="k">Custo estimado</div>
            <div class="v">R$ <%= (Number(ocorrencia.custo || 0)).toFixed(2).replace(".", ",") %></div>
          </div>
        <% } %>

        <div class="line"></div>

        <div>
          <div class="k">Descri√ß√£o</div>
          <div class="v" style="font-size:14px;font-weight:600;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere"><%= ocorrencia.descricao %></div>
        </div>

        <div class="line"></div>
        <div class="section" style="margin-top:0">Anexos</div>

        <% if (!anexos || anexos.length === 0) { %>
          <div class="muted">Nenhum anexo nesta ocorr√™ncia.</div>
          <div class="hint">Dica: anexos s√£o adicionados na cria√ß√£o da ocorr√™ncia (na tela ‚ÄúNovo‚Äù).</div>
        <% } else { %>
          <div class="attachList">
            <% anexos.forEach((a) => { %>
              <div class="attachRow">
                <div class="attachLeft">
                  <div class="attachName"><%= a.originalname %></div>
                  <div class="attachMeta">
                    <% if (a.size !== undefined && a.size !== null) { %>
                      <span><%= bytesToMB(a.size) %></span>
                    <% } %>
                    <% if (a.created_at) { %>
                      <span> ‚Ä¢ </span><span><%= dtNice(a.created_at) %></span>
                    <% } %>
                  </div>
                </div>

                <div class="attachActions">
                  <a class="btn small primary"
                     href="/ocorrencias/<%= ocorrencia.id %>/anexos/<%= a.id %>">
                    ‚¨áÔ∏è Baixar
                  </a>
                </div>
              </div>
            <% }) %>
          </div>

          <div class="hint">
            Se aparecer ‚Äúarquivo n√£o dispon√≠vel‚Äù, √© porque o Render reiniciou e o servidor n√£o est√° com disco persistente (vamos resolver depois).
          </div>
        <% } %>

      </div>

      <div class="card">
        <div class="section">A√ß√µes</div>

        <form method="POST" action="/ocorrencias/<%= ocorrencia.id %>/atualizar">
          <label>Status</label>
          <select name="status" <%= canEdit ? "" : "disabled" %>>
            <% allowed.forEach(s => { %>
              <option value="<%= s %>" <%= String(ocorrencia.status)===String(s) ? "selected" : "" %>><%= s %></option>
            <% }) %>
          </select>

          <% if (!canEdit) { %>
            <div class="hint">
              <% if (String(role)==="comercial") { %>
                Comercial n√£o altera status.
              <% } else if (String(role)==="financeiro") { %>
                Financeiro s√≥ altera quando estiver em <b>Finalizado ‚Äì Financeiro</b>.
              <% } else if (String(role)==="diretor") { %>
                Diretor(a) s√≥ altera quando o status estiver em <b>Diretoria</b>.
              <% } else { %>
                Voc√™ n√£o tem permiss√£o para alterar o status agora.
              <% } %>
            </div>
          <% } %>

          <% if (showResponsavelEdit) { %>
            <label>Respons√°vel (somente Admin)</label>
            <select name="responsavel">
              <% RESPONSAVEIS.forEach(r => { %>
                <option value="<%= r %>" <%= String(ocorrencia.responsavel)===String(r) ? "selected" : "" %>><%= r %></option>
              <% }) %>
            </select>
          <% } else { %>
            <input type="hidden" name="responsavel" value="<%= ocorrencia.responsavel %>">
          <% } %>

          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px">
            <a class="btn" href="/ocorrencias">Voltar</a>
            <button class="btn primary" type="submit" <%= canEdit ? "" : "disabled" %>>Salvar altera√ß√µes</button>
          </div>

          <div class="hint">
            Status oficiais: <b>Aberto</b> ‚Üí <b>Em an√°lise</b> ‚Üí <b>Aguardando cliente</b> ‚Üí <b>Aguardando f√°brica</b> ‚Üí <b>Finalizado ‚Äì Financeiro</b> ‚Üí <b>Diretoria</b>
          </div>
        </form>

        <div class="line"></div>

        <div class="section">Novo coment√°rio</div>
        <form method="POST" action="/ocorrencias/<%= ocorrencia.id %>/comentario">
          <label>Coment√°rio</label>
          <textarea name="comentario" placeholder="Escreva uma atualiza√ß√£o..."></textarea>
          <div style="margin-top:10px">
            <button class="btn primary" type="submit">Adicionar coment√°rio</button>
          </div>
        </form>
      </div>

    </div>

    <div class="card">
      <div class="section">Atividades</div>

      <% if (!ocorrencia.atividades || ocorrencia.atividades.length === 0) { %>
        <div class="muted">Nenhuma atividade registrada ainda.</div>
      <% } else { %>
        <% ocorrencia.atividades.forEach((a) => { %>
          <div class="activity">
            <div class="meta"><b><%= a.quem %></b> ‚Ä¢ <%= a.quando %></div>
            <div class="txt"><%= a.texto %></div>
          </div>
        <% }) %>
      <% } %>
    </div>

  </main>
</div>
</body>
</html>


