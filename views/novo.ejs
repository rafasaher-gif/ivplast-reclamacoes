<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Nova Ocorr√™ncia - IVPLAST</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f4f6fb;color:#0f172a}
    .layout{display:flex;min-height:100vh}
    .sidebar{width:250px;background:#fff;border-right:1px solid #e5e7eb;padding:18px}
    .logo{font-weight:800;color:#2563eb;margin-bottom:20px}
    .menu a{display:block;padding:10px 12px;border-radius:8px;color:#111;text-decoration:none;margin-bottom:6px}
    .menu a.active{background:#eef2ff;color:#1d4ed8;font-weight:600}
    .menu a:hover{background:#f1f5f9}
    .content{flex:1;padding:24px}
    .top{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:20px}
    h1{margin:0;font-size:22px}
    p.sub{margin:4px 0 0;color:#64748b;font-size:13px}
    label{display:block;font-size:13px;margin:10px 0 6px;color:#334155}
    input,select,textarea{
      width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px
    }
    textarea{min-height:110px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    .section{margin-top:18px;font-weight:800;font-size:14px}
    .hint{font-size:12px;color:#64748b;margin-top:4px}
    .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}
    .btn{padding:10px 14px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer;font-weight:700}
    .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    /* radios compactos */
    .radioCompact{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .radioCompact label{margin:0;font-size:13px;color:#0f172a}
    .radioCompact input{width:auto}

    /* ‚úÖ NFD menor + mais espa√ßo para "Algum item foi errado?" */
    .gridNFD{
      display:grid;
      grid-template-columns: 240px 140px 1fr;
      gap:22px;
      align-items:end;
    }

    /* itens (linha item + qtd lado a lado + remover) */
    .itemRow{display:grid;grid-template-columns: 1fr 160px 44px; gap:10px; margin-bottom:10px}
    .itemRow label{margin-top:0}
    .btnIcon{width:44px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;border:1px solid #d1d5db;background:#fff;font-weight:900;cursor:pointer}
    .btnIcon:hover{background:#f8fafc}
    .btnAdd{display:inline-flex;align-items:center;justify-content:center;width:44px;height:40px;border-radius:8px;border:1px solid #2563eb;background:#2563eb;color:#fff;font-weight:900;cursor:pointer}
    .btnAdd:hover{filter:brightness(.95)}

    /* custo menor */
    .costSmall input{max-width:180px}

    /* inputs compactos */
    .inputSmall{width:140px;max-width:140px}

    @media(max-width:980px){
      .sidebar{display:none}
      .grid,.grid3,.gridNFD{grid-template-columns:1fr}
      .itemRow{grid-template-columns:1fr 1fr 44px}
      .content{padding:14px}
      .costSmall input{max-width:100%}
      .inputSmall{width:100%;max-width:100%}
    }
  </style>
</head>

<body>
<div class="layout">

  <!-- MENU -->
  <aside class="sidebar">
    <div class="logo">IVPLAST</div>
    <div class="menu">
      <a href="/dashboard">üè† Menu Principal</a>
      <a href="/novo" class="active">‚ûï Novo</a>
      <a href="/ocorrencias">üîç Busca por Ocorr√™ncia</a>
      <a href="/relatorios">üìä Relat√≥rios</a>
      <a href="/configuracoes">‚öôÔ∏è Configura√ß√µes</a>
      <a href="/auditoria">üßæ Auditoria</a>
      <a href="/logout">üö™ Sair</a>
    </div>
  </aside>

  <!-- CONTE√öDO -->
  <main class="content">
    <div class="top">
      <h1>Nova Ocorr√™ncia</h1>
      <p class="sub">Preencha os dados para registrar a solicita√ß√£o.</p>
      <p class="sub">Logado como: <b><%= usuario.nome %></b></p>
    </div>

    <div class="card">
      <form method="POST" action="/novo" enctype="multipart/form-data">

        <div class="section">Cliente</div>
        <div class="grid">
          <div>
            <label>Raz√£o social</label>
            <input name="razao_social" required>
          </div>
          <div>
            <label>CNPJ</label>
            <input
              id="cnpj"
              name="cnpj"
              placeholder="00.000.000/0000-00"
              inputmode="numeric"
              autocomplete="off"
            >
            <div class="hint">Formato obrigat√≥rio: 00.000.000/0000-00</div>
          </div>
        </div>

        <div class="grid">
          <div>
            <label>N√∫mero do Pedido</label>
            <input name="numero_pedido">
          </div>
          <div>
            <label>N√∫mero da Nota Fiscal</label>
            <input name="numero_nf">
          </div>
        </div>

        <div class="section">Classifica√ß√£o</div>
        <div class="grid">
          <div>
            <label>Faturado por</label>
            <select name="empresa">
              <option value="IVPLAST">IVPLAST</option>
              <option value="VENANI">VENANI</option>
            </select>
          </div>

          <div>
            <label>Motivo / Origem</label>
            <select name="motivo">
              <option value="IVPLAST">F√°brica</option>
              <option value="Cliente">Cliente</option>
              <option value="Transportadora">Transportadora</option>
              <option value="Vendedor">Vendedor</option>
            </select>
          </div>
        </div>

        <div class="grid3">
          <div>
            <label>Respons√°vel</label>
            <select name="responsavel">
              <option>Atendimento</option>
              <option>Comercial</option>
              <option>Qualidade</option>
              <option>Log√≠stica</option>
              <option>Financeiro</option>
              <option>Diretoria</option>
            </select>
          </div>

          <% if (canSeeCost) { %>
          <div class="costSmall">
            <label>Custo estimado (R$)</label>
            <input
              name="custo_estimado"
              type="number"
              step="0.01"
              min="0"
              max="100000"
              placeholder="0,00"
            >
            <div class="hint">M√°ximo: 100.000,00</div>
          </div>
          <% } else { %>
            <input type="hidden" name="custo_estimado">
          <% } %>

          <div>
            <label>Anexos</label>
            <input type="file" name="anexos" multiple>
          </div>
        </div>

        <div class="section">NFD e itens</div>

        <div class="gridNFD">
          <div>
            <label>Cliente j√° emitiu NFD?</label>
            <div class="radioCompact">
              <label><input type="radio" name="cliente_emitiu_nfd" value="nao" checked> N√£o</label>
              <label><input type="radio" name="cliente_emitiu_nfd" value="sim"> Sim</label>
            </div>
          </div>

          <div>
            <label>N√∫mero da NFD</label>
            <input
              id="nfd"
              name="nfd_numero"
              class="inputSmall"
              disabled
              inputmode="numeric"
              placeholder="10 d√≠gitos"
            >
          </div>

          <div>
            <label>Algum item foi errado?</label>
            <div class="radioCompact">
              <label><input type="radio" name="item_errado" value="nao" checked> N√£o</label>
              <label><input type="radio" name="item_errado" value="sim"> Sim</label>
            </div>
          </div>
        </div>

        <!-- Itens din√¢micos -->
        <div id="itensWrap" style="margin-top:12px; display:none;">
          <div class="hint" style="margin-bottom:10px;">
            Adicione os itens (m√°x. 10). Item e quantidade ficam lado a lado. Quantidade m√°x.: 10.000.
          </div>

          <div id="itensList"></div>

          <div style="display:flex; gap:10px; align-items:center; margin-top:6px;">
            <button type="button" class="btnAdd" id="btnAddItem" title="Adicionar item">+</button>
            <div class="hint" id="itensCount"></div>
          </div>

          <div style="margin-top:10px">
            <label>Observa√ß√µes gerais (opcional)</label>
            <input name="item_obs" placeholder="Ex.: veio trocado na separa√ß√£o / faltou no pallet..." />
          </div>
        </div>

        <div class="section">Descri√ß√£o</div>
        <textarea name="descricao" required></textarea>

        <div class="actions">
          <a class="btn" href="/ocorrencias">Cancelar</a>
          <button class="btn primary" type="submit">Salvar ocorr√™ncia</button>
        </div>

      </form>
    </div>
  </main>
</div>

<script>
  // -------- NFD: habilita campo n√∫mero + for√ßa 10 d√≠gitos --------
  function sanitizeDigits(str, maxLen){
    return String(str || "").replace(/\D/g, "").slice(0, maxLen);
  }

  function toggleNFD(){
    const sim = document.querySelector('input[name="cliente_emitiu_nfd"][value="sim"]').checked;
    const nfd = document.getElementById("nfd");
    nfd.disabled = !sim;
    if (!sim) nfd.value = "";
  }
  document.querySelectorAll('input[name="cliente_emitiu_nfd"]').forEach(e=>e.addEventListener("change",toggleNFD));
  toggleNFD();

  (function(){
    const nfd = document.getElementById("nfd");
    if (!nfd) return;

    // corta sempre em 10, digitando ou colando
    const handler = (e) => {
      const v = sanitizeDigits(e.target.value, 10);
      e.target.value = v;
    };

    nfd.addEventListener("input", handler);
    nfd.addEventListener("paste", () => setTimeout(() => handler({ target: nfd }), 0));
  })();

  // -------- Itens: habilita bloco e permite at√© 10 --------
  (function(){
    const wrap = document.getElementById("itensWrap");
    const list = document.getElementById("itensList");
    const btnAdd = document.getElementById("btnAddItem");
    const countEl = document.getElementById("itensCount");
    const MAX_ITENS = 10;

    function renderCount(){
      const n = list.querySelectorAll("[data-item-row]").length;
      countEl.textContent = n ? `${n}/${MAX_ITENS} itens` : "";
      btnAdd.disabled = n >= MAX_ITENS;
    }

    function makeRow(){
      const div = document.createElement("div");
      div.setAttribute("data-item-row", "1");
      div.className = "itemRow";

      div.innerHTML = `
        <div>
          <label>Item (c√≥digo / descri√ß√£o)</label>
          <input name="itens_descricao[]" placeholder="Ex.: 123456 - Bucha 10 (500)">
        </div>

        <div>
          <label>Quantidade</label>
          <input name="itens_quantidade[]" type="number" min="1" max="10000" step="1" placeholder="1">
        </div>

        <div style="display:flex;align-items:end;">
          <button type="button" class="btnIcon" title="Remover">‚úï</button>
        </div>
      `;

      div.querySelector("button").addEventListener("click", () => {
        div.remove();
        renderCount();
      });

      return div;
    }

    function addRow(){
      const n = list.querySelectorAll("[data-item-row]").length;
      if (n >= MAX_ITENS) return;
      list.appendChild(makeRow());
      renderCount();
    }

    function setEnabled(enabled){
      wrap.style.display = enabled ? "block" : "none";
      if (!enabled) {
        list.innerHTML = "";
        renderCount();
      } else {
        if (list.querySelectorAll("[data-item-row]").length === 0) addRow();
      }
    }

    document.querySelectorAll('input[name="item_errado"]').forEach(el => {
      el.addEventListener("change", () => {
        const sim = document.querySelector('input[name="item_errado"][value="sim"]').checked;
        setEnabled(sim);
      });
    });

    btnAdd.addEventListener("click", addRow);

    setEnabled(false);
  })();

  // -------- CNPJ: trava em 14 d√≠gitos e formata sempre 00.000.000/0000-00 --------
  (function(){
    const el = document.getElementById("cnpj");
    if (!el) return;

    function formatCNPJFromDigits(d){
      const digits = String(d || "").replace(/\D/g, "").slice(0, 14);

      let out = digits;
      if (digits.length > 2) out = digits.slice(0,2) + "." + digits.slice(2);
      if (digits.length > 5) out = out.slice(0,6) + "." + out.slice(6);
      if (digits.length > 8) out = out.slice(0,10) + "/" + out.slice(10);
      if (digits.length > 12) out = out.slice(0,15) + "-" + out.slice(15);

      return out;
    }

    const handler = () => {
      const digits = sanitizeDigits(el.value, 14);
      el.value = formatCNPJFromDigits(digits);
    };

    // digitando
    el.addEventListener("input", handler);

    // colando: for√ßa corte + formata√ß√£o
    el.addEventListener("paste", () => setTimeout(handler, 0));

    // ao sair
    el.addEventListener("blur", handler);
  })();
</script>

</body>
</html>
